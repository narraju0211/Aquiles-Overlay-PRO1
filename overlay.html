<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay de Transmissão</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden; /* Evita barras de rolagem */
            background-color: rgba(0, 0, 0, 0); /* Fundo transparente para OBS */
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: space-between; /* Espaçamento entre placar, centro e cartões */
        }

        #placar-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .time-info {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }

        .time-info img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
            object-fit: contain;
            border-radius: 5px; /* Suaviza bordas do escudo */
        }

        .time-info .nome-time {
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        .gols {
            font-size: 3em;
            font-weight: bold;
            margin: 0 10px;
            color: #f39c12; /* Cor destacada para os gols */
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
        }

        /* Seção de Pênaltis (oculta por padrão) */
        #penalties-display {
            position: absolute;
            top: 90px; /* Abaixo do placar principal */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 5px 15px;
            border-radius: 8px;
            color: #ecf0f1;
            font-size: 1.5em;
            font-weight: bold;
            display: flex; /* Para alinhar gols de pênalti */
            gap: 15px;
            align-items: center;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            z-index: 9; /* Um pouco abaixo do placar principal */
            opacity: 0; /* Começa invisível */
            pointer-events: none; /* Não interage com o mouse */
            transition: opacity 0.5s ease-out; /* Transição suave */
        }

        #penalties-display.active {
            opacity: 1; /* Visível quando ativo */
        }

        /* Animação de Gol */
        #animacao-gol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(46, 204, 113, 0.9); /* Verde vibrante */
            padding: 30px 60px;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.7);
            text-align: center;
            z-index: 1000;
            display: none; /* Esconde por padrão */
            opacity: 0;
            animation-duration: 3s; /* Duração total da animação */
            animation-timing-function: ease-out;
            animation-fill-mode: forwards;
        }

        #animacao-gol.show {
            animation-name: fadeInOut;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        #animacao-gol h1 {
            font-size: 5em;
            color: white;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.7);
            margin: 0;
            letter-spacing: 5px;
        }

        #animacao-gol .escudo-gol {
            width: 100px;
            height: 100px;
            margin-top: 15px;
            object-fit: contain;
            border-radius: 50%; /* Opcional: para escudos redondos */
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Seção de Cartões */
        #cartoes-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
            max-height: calc(100vh - 150px); /* Limita altura para não sair da tela */
            overflow-y: auto; /* Adiciona scroll se muitos cartões */
        }

        .cartao {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.85); /* Fundo do cartão */
            padding: 8px 15px;
            border-radius: 8px;
            color: white; /* Texto branco padrão */
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            animation: slideInLeft 0.5s ease-out forwards;
            min-width: 280px; /* Aumenta a largura mínima para caber placar */
            position: relative; /* Para posicionar o placar flutuante */
        }

        .cartao.amarelo {
            border-left: 5px solid #f1c40f; /* Borda amarela */
        }

        .cartao.vermelho {
            border-left: 5px solid #e74c3c; /* Borda vermelha */
        }

        .cartao img.escudo-time {
            width: 35px; /* Tamanho do escudo no cartão */
            height: 35px;
            margin-right: 10px;
            object-fit: contain;
            border-radius: 4px;
        }

        .cartao .icone-cartao {
            width: 30px; /* Tamanho do ícone do cartão */
            height: 30px;
            margin-left: auto; /* Empurra para a direita */
            object-fit: contain;
        }

        .cartao .nome-jogador {
            flex-grow: 1; /* O nome do jogador ocupa o espaço restante */
            margin-right: 10px; /* Espaço antes do ícone do cartão */
        }

        /* Prévia de Placar dentro do Cartão */
        .cartao .placar-preview {
            position: absolute;
            top: -10px; /* Levemente acima do topo do cartão */
            right: 10px; /* À direita */
            background-color: rgba(0, 0, 0, 0.9);
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: normal;
            color: #ecf0f1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            white-space: nowrap; /* Evita quebra de linha */
        }


        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>

    <div id="placar-container">
        <div class="time-info">
            <img id="escudoCasa" src="https://via.placeholder.com/50x50?text=Casa" alt="Escudo Time Casa">
            <span id="nomeCasa" class="nome-time">Time A</span>
        </div>
        <span id="golsCasa" class="gols">0</span>
        <span class="gols">X</span>
        <span id="golsVisitante" class="gols">0</span>
        <div class="time-info">
            <span id="nomeVisitante" class="nome-time">Time B</span>
            <img id="escudoVisitante" src="https://via.placeholder.com/50x50?text=Vis" alt="Escudo Time Visitante">
        </div>
    </div>

    <div id="penalties-display">
        Pênaltis: <span id="penaltiesCasaDisplay">0</span> x <span id="penaltiesVisitanteDisplay">0</span>
    </div>

    <div id="animacao-gol">
        <h1>GOOOOL!</h1>
        <img id="escudoAnimacaoGol" class="escudo-gol" src="" alt="Escudo do Time do Gol" style="display: none;">
    </div>

    <div id="cartoes-container">
        </div>

    <script>
        // Ícones padrão para cartões (se você não tiver os seus próprios)
        const ICONE_AMARELO = 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Yellow_card.svg/1200px-Yellow_card.svg.png';
        const ICONE_VERMELHO = 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Red_card.svg/1200px-Red_card.svg.png';

        // Variável global para armazenar cartões ativos (evita duplicação visual e ajuda a gerenciar)
        let cartoesAtivos = {};

        // --- Funções de Recebimento e Processamento de Dados ---
        // Esta função será o ponto de entrada para todos os dados enviados pelo controlador
        function handleOverlayData(data) {
            console.log('Dados recebidos na Overlay:', data);
            switch (data.type) {
                case 'atualizar_placar':
                    atualizarPlacarDisplay(data);
                    break;
                case 'mostrar_gol':
                    mostrarAnimacaoGol(data.escudoGol);
                    // O placar também será atualizado pelo 'atualizar_placar' que o controlador envia logo após o gol
                    break;
                case 'enviar_cartao':
                    adicionarCartao(data);
                    break;
                case 'limpar_cartoes':
                    limparTodosCartoes();
                    break;
                case 'atualizar_penalties':
                    atualizarPenaltiesDisplay(data);
                    break;
                case 'inicio_jogo':
                    // Lógica para início de jogo, se houver
                    break;
                case 'fim_jogo':
                    // Lógica para fim de jogo, se houver
                    limparTodosCartoes(); // Limpa cartões ao final do jogo
                    break;
                default:
                    console.warn('Tipo de dado desconhecido:', data.type);
            }
        }

        // --- Funções de Atualização da Interface da Overlay ---

        // Função para atualizar o placar na overlay (Corrigido para não duplicar)
        function atualizarPlacarDisplay(data) {
            document.getElementById('nomeCasa').innerText = data.timeCasa || 'Time A';
            document.getElementById('nomeVisitante').innerText = data.timeVisitante || 'Time B';
            document.getElementById('golsCasa').innerText = data.golsCasa !== undefined ? data.golsCasa : '0';
            document.getElementById('golsVisitante').innerText = data.golsVisitante !== undefined ? data.golsVisitante : '0';

            // Atualiza os escudos, se os links forem fornecidos
            document.getElementById('escudoCasa').src = data.escudoCasa || 'https://via.placeholder.com/50x50?text=Casa';
            document.getElementById('escudoVisitante').src = data.escudoVisitante || 'https://via.placeholder.com/50x50?text=Vis';
        }

        // Função para mostrar a animação de gol (com escudo)
        function mostrarAnimacaoGol(escudoSrc) {
            const animacaoGol = document.getElementById('animacao-gol');
            const escudoAnimacaoGol = document.getElementById('escudoAnimacaoGol');

            if (escudoSrc) {
                escudoAnimacaoGol.src = escudoSrc;
                escudoAnimacaoGol.style.display = 'block';
            } else {
                escudoAnimacaoGol.style.display = 'none';
            }

            animacaoGol.style.display = 'block'; // Garante que o elemento esteja visível antes de adicionar a classe
            animacaoGol.classList.remove('show'); // Reseta a animação se já estiver lá
            void animacaoGol.offsetWidth; // Força reflow para reiniciar animação
            animacaoGol.classList.add('show');

            setTimeout(() => {
                animacaoGol.classList.remove('show');
                animacaoGol.style.display = 'none'; // Esconde completamente após a animação
                escudoAnimacaoGol.style.display = 'none'; // Garante que o escudo desaparece junto
            }, 3000);
        }

        // Função para adicionar um cartão (com prévia de placar e escudo)
        function adicionarCartao(data) {
            const container = document.getElementById('cartoes-container');
            // Usar o nome do jogador, tipo e time para um ID único do cartão.
            // Isso evita que o mesmo cartão seja adicionado múltiplas vezes.
            const cardId = `card-${data.jogador.replace(/\s/g, '-')}-${data.tipo}-${data.time}`;

            // Se o cartão já existe, não adiciona novamente
            if (cartoesAtivos[cardId]) {
                console.warn(`Cartão para ${data.jogador} (${data.tipo}) já existe na tela.`);
                // Opcional: Você pode adicionar uma animação de "piscar" aqui
                return;
            }

            const cartaoDiv = document.createElement('div');
            cartaoDiv.className = `cartao ${data.tipo}`;
            cartaoDiv.id = cardId;

            const iconeCartaoSrc = (data.tipo === 'amarelo') ? ICONE_AMARELO : ICONE_VERMELHO;

            cartaoDiv.innerHTML = `
                ${data.escudoTime ? `<img src="${data.escudoTime}" alt="Escudo Time" class="escudo-time">` : ''}
                <span class="nome-jogador">${data.jogador}</span>
                <img src="${iconeCartaoSrc}" alt="Cartão ${data.tipo}" class="icone-cartao">
                <span class="placar-preview">${data.golsCasa} x ${data.golsVisitante}</span>
            `;
            container.appendChild(cartaoDiv);

            cartoesAtivos[cardId] = cartaoDiv; // Adiciona ao controle de cartões ativos

            // Define um tempo para o cartão desaparecer (ajuste conforme necessário)
            setTimeout(() => {
                removerCartao(cardId);
            }, 8000); // Cartão desaparece após 8 segundos
        }

        // Função para remover um cartão (com animação de saída)
        function removerCartao(cardId) {
            const cartaoDiv = document.getElementById(cardId);
            if (cartaoDiv) {
                cartaoDiv.style.animation = 'slideOutLeft 0.5s ease-out forwards';
                setTimeout(() => {
                    cartaoDiv.remove();
                    delete cartoesAtivos[cardId]; // Remove do controle
                }, 500); // Espera a animação de saída terminar
            }
        }

        // Função para limpar todos os cartões (ex: ao final do jogo)
        function limparTodosCartoes() {
            const container = document.getElementById('cartoes-container');
            // Remove com animação todos os cartões ativos
            for (const id in cartoesAtivos) {
                removerCartao(id);
            }
            // Garante que o objeto de controle esteja vazio após a remoção
            setTimeout(() => {
                cartoesAtivos = {};
                container.innerHTML = ''; // Limpeza final
            }, 600); // Um pouco mais do que a duração da animação de saída
        }

        // Função para atualizar a exibição dos pênaltis
        function atualizarPenaltiesDisplay(data) {
            const penaltiesDisplay = document.getElementById('penalties-display');
            document.getElementById('penaltiesCasaDisplay').innerText = data.penaltiesCasa;
            document.getElementById('penaltiesVisitanteDisplay').innerText = data.penaltiesVisitante;

            if (data.penaltiesCasa > 0 || data.penaltiesVisitante > 0) {
                penaltiesDisplay.classList.add('active'); // Mostra a barra de pênaltis
            } else {
                penaltiesDisplay.classList.remove('active'); // Esconde se não houver pênaltis
            }
        }

        // --- Configuração da Comunicação (Escolha uma opção para produção) ---

        // Opção 1: Usando window.postMessage (Bom para testes locais ou iFrames)
        // O controlador deve enviar mensagens para a janela da overlay usando:
        // window.opener.postMessage(data, '*'); OU targetWindow.postMessage(data, '*');
        window.addEventListener('message', (event) => {
            // Verifique event.origin para segurança em produção
            if (event.data && typeof event.data === 'object' && event.data.type) {
                handleOverlayData(event.data);
            }
        });

        // Opção 2: WebSockets (Recomendado para produção para comunicação em tempo real)
        /*
        let ws;
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8080'); // Mude para o endereço do seu servidor WebSocket
            ws.onopen = () => console.log('WebSocket conectado à Overlay!');
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleOverlayData(data);
            };
            ws.onclose = () => {
                console.log('WebSocket desconectado. Tentando reconectar em 3s...');
                setTimeout(connectWebSocket, 3000); // Tenta reconectar
            };
            ws.onerror = (error) => console.error('WebSocket Error:', error);
        }
        connectWebSocket();
        */

        // Inicializa o placar com valores padrão ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            atualizarPlacarDisplay({
                timeCasa: 'Time A',
                golsCasa: 0,
                timeVisitante: 'Time B',
                golsVisitante: 0,
                escudoCasa: 'https://via.placeholder.com/50x50?text=Casa',
                escudoVisitante: 'https://via.placeholder.com/50x50?text=Vis'
            });
            atualizarPenaltiesDisplay({ penaltiesCasa: 0, penaltiesVisitante: 0 });
        });

    </script>
</body>
</html>
