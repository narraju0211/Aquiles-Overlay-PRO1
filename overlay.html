<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Aquiles Overlay PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --placar-bg-rgb: 34, 34, 34;
      --placar-opacity: 0.9;
      --placar-text: white;
      --placar-border: #555;
      --placar-timer-color: #0ff; /* Cor padrão para o timer */
      --highlight-color: #0ff; /* Cor padrão para destaques */
      --animation-duration: 0.5s; 
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden; 
      background-color: rgba(0, 0, 0, 0); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start; 
      height: 100vh;
      width: 100vw;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Container principal que gerencia o placar normal, pênaltis e animação de gol */
    .main-display-wrapper {
        position: relative; /* Para posicionar placar, pênaltis, animação um sobre o outro */
        top: 50px; 
        width: auto; /* Ajusta à largura do conteúdo */
        height: 100px; /* Altura aproximada do placar para manter o layout */
        display: flex; /* Para centralizar o wrapper na tela */
        justify-content: center;
        align-items: center;
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        will-change: transform, opacity;
    }

    .main-display-wrapper.hidden {
        opacity: 0 !important;
        transform: translateY(-50px) !important;
        pointer-events: none; 
    }

    .container, .penalties-container, .goal-animation-overlay {
        position: absolute; /* Todos ocupam o mesmo espaço */
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 25px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        font-weight: bold;
        font-size: 4em; 
        white-space: nowrap; 
        transition: opacity 0.3s ease-in-out, visibility 0.3s; /* Transição para aparecer/desaparecer */
        opacity: 0; /* Por padrão, invisível */
        visibility: hidden; /* Esconde para não ser interativo */
    }

    /* Estilo para o placar normal */
    .container {
        background-color: rgba(var(--placar-bg-rgb), var(--placar-opacity)); 
        border: 2px solid var(--placar-border);
        color: var(--placar-text);
        z-index: 1; /* Estará abaixo da animação/pênaltis quando ativo */
    }

    /* Estilo para o modo de pênaltis */
    .penalties-container {
        background-color: rgba(var(--placar-bg-rgb), 0.98);
        border: 2px solid var(--placar-border);
        color: var(--placar-text);
        z-index: 2; /* Acima do placar normal */
    }

    /* Estilo para a animação de gol */
    .goal-animation-overlay {
        background-color: transparent; /* Transparente, apenas o texto importa */
        border: none;
        color: var(--highlight-color);
        font-size: 5em; /* Aumenta o tamanho para o "GOL!" */
        text-shadow: 0 0 20px rgba(0, 255, 255, 1), 0 0 40px rgba(0, 255, 255, 0.7); /* Efeito neon */
        z-index: 3; /* Mais alto de tudo */
        pointer-events: none; /* Não deve bloquear cliques */
        animation: goalAppear 0.5s ease-out forwards; /* Animação de entrada do texto GOL */
    }

    @keyframes goalAppear {
        from { opacity: 0; transform: scale(0.5); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Classes para controlar a visibilidade */
    .container.active, .penalties-container.active, .goal-animation-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Animação para o container principal aparecer */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .team {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 0 10px;
    }

    .team-name-abbr {
        font-size: 0.4em; 
        margin-top: 5px; 
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(var(--placar-text), 0.8);
    }
    .score {
      font-size: 1.5em; 
      min-width: 50px; 
      text-align: center;
      color: var(--highlight-color);
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
    }

    .separator {
      margin: 0 20px;
      font-size: 1.2em;
      color: var(--placar-text);
    }

    .logo-overlay {
      height: 80px; 
      width: auto;
      margin: 0 20px;
      transition: opacity 0.3s ease-out;
    }

    /* Cronômetro e período na mesma linha do placar */
    .timer-period-group {
        position: absolute; /* Posiciona relativo ao .container */
        display: flex;
        align-items: center;
        background-color: rgba(var(--placar-bg-rgb), 1); 
        padding: 5px 15px;
        border-radius: 10px;
        border: 1px solid var(--placar-border);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        font-size: 0.6em; /* Relativo ao font-size do .container */
        min-width: 120px; 
        text-align: center;
        letter-spacing: 1px;
    }
    #timer {
        color: var(--placar-timer-color);
        margin-right: 10px; /* Espaço entre timer e período */
    }
    #period {
        color: rgba(var(--placar-timer-color), 0.8);
    }

    /* Posição do timer/período */
    .timer-period-group.left {
        left: -80px; /* Ajuste para a esquerda do placar */
        top: 50%;
        transform: translateY(-50%);
    }
    .timer-period-group.right {
        right: -80px; /* Ajuste para a direita do placar */
        top: 50%;
        transform: translateY(-50%);
    }


    .escudo {
      height: 70px; 
      width: auto;
      object-fit: contain;
    }

    /* Cartões agora são posicionados abaixo de seus respectivos times */
    .cards-container {
        position: absolute; /* Relativo ao main-display-wrapper */
        bottom: -35px; /* Abaixo do placar */
        width: 100%;
        display: flex;
        justify-content: space-between; /* Empurra os grupos para os cantos */
        padding: 0 20px; /* Padding para não colar nas bordas */
        box-sizing: border-box; /* Inclui padding na largura total */
        opacity: 0; /* Invisível por padrão */
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s;
    }
    .cards-container.active {
        opacity: 1;
        visibility: visible;
    }
    .card-group {
        display: flex;
        align-items: center;
        gap: 5px; 
        background-color: rgba(var(--placar-bg-rgb), 0.95);
        padding: 5px 15px;
        border-radius: 10px;
        border: 1px solid var(--placar-border);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    .card-icon {
        width: 20px; 
        height: 28px; 
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,0.2);
    }
    .card-icon.yellow { background-color: #ffc107; }
    .card-icon.red { background-color: #dc3545; }
    .card-count {
        font-size: 0.5em; /* Relativo ao font-size do .container */
        color: var(--placar-text);
        font-weight: bold;
    }

    /* Modo Pênaltis - estilos internos */
    .penalty-team {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    .penalty-score-label {
        font-size: 0.8em; 
        margin-bottom: 5px;
        color: var(--highlight-color);
    }
    .penalty-marks {
        display: flex;
        gap: 8px; 
    }
    .penalty-mark {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background-color: #555; 
        border: 2px solid #777;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
    }
    .penalty-mark.green {
        background-color: #28a745; 
        border-color: #218838;
    }
    .penalty-mark.red {
        background-color: #dc3545; 
        border-color: #c82333;
    }
  </style>
</head>
<body>
  <div class="main-display-wrapper" id="mainDisplayWrapper">
    
    <div class="container" id="overlayContainer">
      <div class="team team1">
        <img src="" alt="Escudo Time 1" class="escudo" id="escudo1">
        <span class="team-name-abbr" id="nomeAbbr1">T1</span>
        <span class="score" id="placar1">0</span>
      </div>

      <img src="" alt="Sua Logo" class="logo-overlay" id="logoOverlay">

      <div class="team team2">
        <span class="score" id="placar2">0</span>
        <span class="team-name-abbr" id="nomeAbbr2">T2</span>
        <img src="" alt="Escudo Time 2" class="escudo" id="escudo2">
      </div>

      <div class="timer-period-group left">
        <div id="timer">00:00</div>
        <div id="period">1º T</div>
      </div>
    </div>

    <div class="penalties-container" id="penaltiesContainer">
        <div class="penalty-team team1-penalties">
            <span class="penalty-score-label" id="penaltyScore1">Pênaltis T1: 0</span>
            <div class="penalty-marks" id="penaltyMarks1">
                </div>
        </div>
        <div class="penalty-team team2-penalties">
            <span class="penalty-score-label" id="penaltyScore2">Pênaltis T2: 0</span>
            <div class="penalty-marks" id="penaltyMarks2">
                </div>
        </div>
    </div>

    <div class="goal-animation-overlay" id="goalAnimationOverlay">
        GOL!
    </div>

    <div class="cards-container" id="cardsContainer">
        <div class="card-group team1-cards">
            <div class="card-icon yellow"></div>
            <span class="card-count" id="cards1Yellow">0</span>
            <div class="card-icon red"></div>
            <span class="card-count" id="cards1Red">0</span>
        </div>
        <div class="card-group team2-cards">
            <div class="card-icon yellow"></div>
            <span class="card-count" id="cards2Yellow">0</span>
            <div class="card-icon red"></div>
            <span class="card-count" id="cards2Red">0</span>
        </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ** SEU FIREBASE CONFIG ESTÁ AQUI (MANTIDO O SEU ORIGINAL) **
    const firebaseConfig = {
      apiKey: "AIzaSyAFp_iujrtqjiTU5yq2yNSBIpwgjQZZyns",
      authDomain: "aquilesplacarpro.firebaseapp.com",
      databaseURL: "https://aquilesplacarpro-default-rtdb.firebaseio.com",
      projectId: "aquilesplacarpro",
      storageBucket: "aquilesplacarpro.firebasestorage.app",
      messagingSenderId: "922321609151",
      appId: "1:922321609151:web:ba51f5b21b322cf0a4c10a"
    };

    // Inicialize o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = app.database();

    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('channel') || 'default_channel'; 
    console.log(`Overlay: Ativa para o canal: ${gameId}`);

    const gameRef = database.ref('channels').child(gameId); 

    const placar1Element = document.getElementById('placar1');
    const placar2Element = document.getElementById('placar2');
    const nomeAbbr1Element = document.getElementById('nomeAbbr1');
    const nomeAbbr2Element = document.getElementById('nomeAbbr2');
    const escudo1Element = document.getElementById('escudo1');
    const escudo2Element = document.getElementById('escudo2');
    const logoOverlayElement = document.getElementById('logoOverlay');
    const timerElement = document.getElementById('timer');
    const periodElement = document.getElementById('period');
    const mainDisplayWrapper = document.getElementById('mainDisplayWrapper'); // Novo wrapper
    const overlayContainer = document.getElementById('overlayContainer'); // O placar normal
    const cardsContainer = document.getElementById('cardsContainer');
    const cards1YellowElement = document.getElementById('cards1Yellow');
    const cards1RedElement = document.getElementById('cards1Red');
    const cards2YellowElement = document.getElementById('cards2Yellow');
    const cards2RedElement = document.getElementById('cards2Red');
    const penaltiesContainer = document.getElementById('penaltiesContainer'); // Modo de pênaltis
    const penaltyScore1Element = document.getElementById('penaltyScore1');
    const penaltyScore2Element = document.getElementById('penaltyScore2');
    const penaltyMarks1Element = document.getElementById('penaltyMarks1');
    const penaltyMarks2Element = document.getElementById('penaltyMarks2');
    const goalAnimationOverlay = document.getElementById('goalAnimationOverlay'); // Animação de gol

    let currentOverlayState = {
      placar: { '1': 0, '2': 0 },
      cards: { '1': { 'amarelo': 0, 'vermelho': 0 }, '2': { 'amarelo': 0, 'vermelho': 0 } },
      penalties: { '1': [], '2': [] },
      seconds: 0,
      timerRunning: false,
      placarThemeIndex: 0,
      placarOpacity: 90, 
      penaltyModeActive: false,
      activeAnimation: null, // 'goalAnimation' ou null
      currentPeriod: 1,
      nome1: '',
      nome2: '',
      nomeAbbr1: 'T1', 
      nomeAbbr2: 'T2', 
      escudo1: '',
      escudo2: '',
      logoOverlay: '', 
      isVisible: true
    };

    let timerDisplayInterval;

    const placarThemes = [
      { rgb: '34, 34, 34', text: 'white', border: '#555', timerColor: '#0ff' }, 
      { rgb: '0, 123, 255', text: 'white', border: '#0056b3', timerColor: '#fff' },
      { rgb: '40, 167, 69', text: 'white', border: '#218838', timerColor: '#fff' },
      { rgb: '220, 53, 69', text: 'white', border: '#c82333', timerColor: '#fff' },
      { rgb: '255, 193, 7', text: 'black', border: '#e0a800', timerColor: '#333' }
    ];

    const periodNames = {
        0: 'Parado',
        1: '1º T', 
        2: '2º T',
        3: 'Prorrog', 
        4: 'Int', 
        5: 'T. Extra' 
    };

    document.addEventListener('DOMContentLoaded', () => {
      console.log("Overlay: DOMContentLoaded - Configurando listener Firebase.");
      gameRef.on('value', (snapshot) => { 
        if (snapshot.exists()) {
          const data = snapshot.val();
          console.log("Overlay: Dados recebidos do Firebase:", data);
          
          // Atualiza o estado da overlay com os dados do Firebase, garantindo valores padrão
          Object.assign(currentOverlayState, { 
            placar: { '1': 0, '2': 0 },
            cards: { '1': { 'amarelo': 0, 'vermelho': 0 }, '2': { 'amarelo': 0, 'vermelho': 0 } },
            penalties: { '1': [], '2': [] },
            seconds: 0,
            timerRunning: false,
            placarThemeIndex: 0,
            placarOpacity: 90, 
            penaltyModeActive: false,
            activeAnimation: null,
            currentPeriod: 1,
            nome1: '',
            nome2: '',
            nomeAbbr1: 'T1', 
            nomeAbbr2: 'T2', 
            escudo1: '',
            escudo2: '',
            logoOverlay: '', 
            isVisible: true,
            ...data 
          });

          // Gerencia o cronômetro do display localmente
          if (currentOverlayState.timerRunning) {
              if (!timerDisplayInterval) { // Apenas se já não estiver rodando
                  startTimerDisplay();
              }
          } else {
              stopTimerDisplay(); // Garante que pare se o controlador pausou
          }

          updateOverlay();
          applyTheme();
        } else {
          console.log(`Overlay: Nenhum dado no Firebase para o canal '${gameId}'. Exibindo padrões.`);
          // Limpa a overlay se não houver dados no Firebase (reseta para o estado inicial)
          Object.assign(currentOverlayState, {
              placar: { '1': 0, '2': 0 },
              cards: { '1': { 'amarelo': 0, 'vermelho': 0 }, '2': { 'amarelo': 0, 'vermelho': 0 } },
              penalties: { '1': [], '2': [] },
              seconds: 0,
              timerRunning: false,
              placarThemeIndex: 0,
              placarOpacity: 90,
              penaltyModeActive: false,
              activeAnimation: null,
              currentPeriod: 1,
              nome1: '',
              nome2: '',
              nomeAbbr1: 'T1',
              nomeAbbr2: 'T2',
              escudo1: '',
              escudo2: '',
              logoOverlay: '',
              isVisible: true
          });
          updateOverlay();
          applyTheme();
          stopTimerDisplay(); // Garante que o timer pare se não houver dados
        }
      });
    });

    function formatTime(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimerDisplay() {
        if (timerDisplayInterval) {
            clearInterval(timerDisplayInterval);
        }
        timerDisplayInterval = setInterval(() => {
            timerElement.textContent = formatTime(currentOverlayState.seconds);
        }, 1000);
        console.log("Overlay: Timer display iniciado.");
    }

    function stopTimerDisplay() {
        if (timerDisplayInterval) {
            clearInterval(timerDisplayInterval);
            timerDisplayInterval = null;
            console.log("Overlay: Timer display parado.");
        }
    }

    function updateOverlay() {
      placar1Element.textContent = currentOverlayState.placar['1'];
      placar2Element.textContent = currentOverlayState.placar['2'];
      nomeAbbr1Element.textContent = currentOverlayState.nomeAbbr1 || 'T1'; 
      nomeAbbr2Element.textContent = currentOverlayState.nomeAbbr2 || 'T2'; 

      // Fallback para uma imagem transparente para evitar ícones de imagem quebrada
      escudo1Element.src = currentOverlayState.escudo1 || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; 
      escudo2Element.src = currentOverlayState.escudo2 || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
      logoOverlayElement.src = currentOverlayState.logoOverlay || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';


      timerElement.textContent = formatTime(currentOverlayState.seconds);
      periodElement.textContent = periodNames[currentOverlayState.currentPeriod] || 'N/A';

      cards1YellowElement.textContent = (currentOverlayState.cards['1'] && currentOverlayState.cards['1']['amarelo'] !== undefined) ? currentOverlayState.cards['1']['amarelo'] : 0;
      cards1RedElement.textContent = (currentOverlayState.cards['1'] && currentOverlayState.cards['1']['vermelho'] !== undefined) ? currentOverlayState.cards['1']['vermelho'] : 0;
      cards2YellowElement.textContent = (currentOverlayState.cards['2'] && currentOverlayState.cards['2']['amarelo'] !== undefined) ? currentOverlayState.cards['2']['amarelo'] : 0;
      cards2RedElement.textContent = (currentOverlayState.cards['2'] && currentOverlayState.cards['2']['vermelho'] !== undefined) ? currentOverlayState.cards['2']['vermelho'] : 0;

      // === Lógica de visibilidade dos elementos principais ===
      // Primeiro, esconde todos os displays principais
      overlayContainer.classList.remove('active');
      penaltiesContainer.classList.remove('active');
      goalAnimationOverlay.classList.remove('active');
      cardsContainer.classList.remove('active'); // Assume que os cartões podem ter sua própria lógica de ativação

      // Controla a visibilidade do mainDisplayWrapper (o placar inteiro)
      if (currentOverlayState.isVisible) {
          mainDisplayWrapper.classList.remove('hidden');
      } else {
          mainDisplayWrapper.classList.add('hidden');
      }

      // Decide qual display deve estar ativo
      if (currentOverlayState.activeAnimation === 'goalAnimation') {
          goalAnimationOverlay.classList.add('active');
          // No modo de gol, placar e pênaltis devem estar ocultos
      } else if (currentOverlayState.penaltyModeActive) {
          penaltiesContainer.classList.add('active');
          renderPenalties(); // Renderiza os pênaltis sempre que o modo estiver ativo
      } else {
          overlayContainer.classList.add('active'); // Exibe o placar normal
          // Só exibe cartões se não estiver em modo de pênalti ou animação de gol E se houver algum cartão
          const hasAnyCard = (currentOverlayState.cards['1']['amarelo'] > 0 || currentOverlayState.cards['1']['vermelho'] > 0 ||
                              currentOverlayState.cards['2']['amarelo'] > 0 || currentOverlayState.cards['2']['vermelho'] > 0);
          if (hasAnyCard) {
              cardsContainer.classList.add('active');
          }
      }
    }

    function applyTheme() {
        const theme = placarThemes[currentOverlayState.placarThemeIndex];
        document.documentElement.style.setProperty('--placar-bg-rgb', theme.rgb);
        document.documentElement.style.setProperty('--placar-text', theme.text);
        document.documentElement.style.setProperty('--placar-border', theme.border);
        document.documentElement.style.setProperty('--placar-timer-color', theme.timerColor);
        document.documentElement.style.setProperty('--placar-opacity', currentOverlayState.placarOpacity / 100);
    }

    function renderPenalties() {
        let converted1 = 0;
        penaltyMarks1Element.innerHTML = '';
        const team1Penalties = currentOverlayState.penalties['1'] || [];
        for (let i = 0; i < 5; i++) { 
            const mark = document.createElement('div');
            mark.classList.add('penalty-mark');
            if (team1Penalties[i]) {
                mark.classList.add(team1Penalties[i]);
                if (team1Penalties[i] === 'green') converted1++;
            }
            penaltyMarks1Element.appendChild(mark);
        }
        penaltyScore1Element.textContent = `Pênaltis T1: ${converted1}`;

        let converted2 = 0;
        penaltyMarks2Element.innerHTML = '';
        const team2Penalties = currentOverlayState.penalties['2'] || [];
        for (let i = 0; i < 5; i++) { 
            const mark = document.createElement('div');
            mark.classList.add('penalty-mark');
            if (team2Penalties[i]) {
                mark.classList.add(team2Penalties[i]);
                if (team2Penalties[i] === 'green') converted2++;
            }
            penaltyMarks2Element.appendChild(mark);
        }
        penaltyScore2Element.textContent = `Pênaltis T2: ${converted2}`;
    }
  </script>
</body>
              </html>
