<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Aquiles Overlay PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --placar-bg-rgb: 34, 34, 34;
      --placar-opacity: 0.9;
      --placar-text: white;
      --placar-border: #555;
      --placar-timer-color: #0ff;
      --highlight-color: #0ff; 
      --animation-duration: 0.5s; 
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden; /* Esconde qualquer conteúdo que exceda as bordas */
      background-color: rgba(0, 0, 0, 0); /* Fundo transparente para overlay */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center; /* Centraliza horizontalmente */
      align-items: flex-start; /* Alinha no topo verticalmente */
      height: 100vh; /* Ocupa 100% da altura da viewport */
      width: 100vw; /* Ocupa 100% da largura da viewport */
      -webkit-font-smoothing: antialiased; /* Melhoria na renderização de fontes */
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      position: relative; /* Para posicionar elementos filhos como o timer e cards */
      top: 50px; /* Desloca o placar para baixo para não ficar colado no topo */
      display: flex;
      align-items: center; /* Alinha os itens verticalmente no centro */
      background-color: rgba(var(--placar-bg-rgb), var(--placar-opacity)); 
      border: 2px solid var(--placar-border);
      border-radius: 15px;
      padding: 10px 25px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
      color: var(--placar-text);
      font-weight: bold;
      font-size: 4em; /* Tamanho base da fonte, os outros serão relativos */
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out, background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease;
      animation: fadeIn 0.5s ease-out forwards; /* Animação de entrada */
      will-change: transform, opacity; /* Otimização para animações */
      white-space: nowrap; /* Evita que o placar quebre a linha */
    }

    .container.hidden {
        opacity: 0 !important;
        transform: translateY(-50px) !important;
        pointer-events: none; /* Não interage com o mouse quando oculto */
    }

    /* Animação para o container aparecer */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .team {
      display: flex;
      align-items: center;
      gap: 15px; /* Espaço entre escudo, nome e placar */
      padding: 0 10px;
    }

    .team-name-abbr {
        font-size: 0.4em; /* Relativo ao font-size do .container */
        margin-top: 5px; 
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(var(--placar-text), 0.8);
    }
    .score {
      font-size: 1.5em; /* Relativo ao font-size do .container */
      min-width: 50px; /* Garante que o placar tenha um tamanho mínimo */
      text-align: center;
      color: var(--highlight-color);
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
    }

    .separator {
      margin: 0 20px;
      font-size: 1.2em;
      color: var(--placar-text);
    }

    .logo-overlay {
      height: 80px; /* Altura fixa para a logo */
      width: auto;
      margin: 0 20px;
      transition: opacity 0.3s ease-out;
    }

    .timer-container {
      position: absolute;
      top: -45px; /* Posição acima do placar */
      background-color: rgba(var(--placar-bg-rgb), 1); /* Fundo sólido para o timer */
      padding: 5px 15px;
      border-radius: 10px;
      font-size: 0.6em; /* Relativo ao font-size do .container */
      color: var(--placar-timer-color);
      border: 1px solid var(--placar-border);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      min-width: 120px; 
      text-align: center;
      letter-spacing: 1px;
    }

    .timer-period {
        font-size: 0.7em; /* Relativo ao font-size do .timer-container */
        color: rgba(var(--placar-timer-color), 0.8); 
    }

    .escudo {
      height: 70px; /* Altura fixa para os escudos */
      width: auto;
      object-fit: contain; /* Garante que a imagem se encaixe sem distorcer */
    }

    .cards-container {
        position: absolute;
        bottom: -35px; /* Posição abaixo do placar */
        display: flex;
        gap: 10px; /* Espaço entre os grupos de cartões */
        background-color: rgba(var(--placar-bg-rgb), 0.95);
        padding: 5px 15px;
        border-radius: 10px;
        border: 1px solid var(--placar-border);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    .card-group {
        display: flex;
        align-items: center;
        gap: 5px; /* Espaço entre ícone e contagem */
    }
    .card-icon {
        width: 20px; 
        height: 28px; 
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,0.2);
    }
    .card-icon.yellow { background-color: #ffc107; }
    .card-icon.red { background-color: #dc3545; }
    .card-count {
        font-size: 0.5em; /* Relativo ao font-size do .container */
        color: var(--placar-text);
        font-weight: bold;
    }

    /* Animação de Gol */
    @keyframes goalBounce {
        0%, 100% { transform: translateY(0); }
        25% { transform: translateY(-10px); }
        50% { transform: translateY(5px); }
        75% { transform: translateY(-5px); }
    }
    .container.goal-animation .score {
        animation: goalBounce var(--animation-duration) ease-out;
        transform-origin: bottom; /* Faz a animação parecer que salta do fundo */
    }

    /* Modo Pênaltis */
    .penalties-container {
        position: absolute;
        /* Centraliza perfeitamente na tela do OBS, não no placar */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); 
        display: flex;
        gap: 30px; /* Espaço entre os times de pênaltis */
        background-color: rgba(var(--placar-bg-rgb), 0.98);
        border: 2px solid var(--placar-border);
        border-radius: 15px;
        padding: 20px 30px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
        color: var(--placar-text);
        font-weight: bold;
        z-index: 10; /* Garante que fique acima do placar normal */
        opacity: 0; /* Começa invisível */
        visibility: hidden; /* Esconde para não ser interativo */
        transition: opacity 0.5s ease-out, visibility 0.5s; /* Transição suave */
    }
    .penalties-container.active {
        opacity: 1;
        visibility: visible;
    }
    .penalty-team {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    .penalty-score-label {
        font-size: 0.8em; /* Relativo ao font-size do .penalties-container */
        margin-bottom: 5px;
        color: var(--highlight-color);
    }
    .penalty-marks {
        display: flex;
        gap: 8px; /* Espaço entre as bolinhas de pênalti */
    }
    .penalty-mark {
        width: 25px;
        height: 25px;
        border-radius: 50%; /* Bolinha perfeita */
        background-color: #555; /* Cor padrão para pênaltis não batidos */
        border: 2px solid #777;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
    }
    .penalty-mark.green {
        background-color: #28a745; 
        border-color: #218838;
    }
    .penalty-mark.red {
        background-color: #dc3545; 
        border-color: #c82333;
    }
  </style>
</head>
<body>
  <div class="container" id="overlayContainer">
    <div class="team team1">
      <img src="" alt="Escudo Time 1" class="escudo" id="escudo1">
      <span class="team-name-abbr" id="nomeAbbr1">T1</span>
      <span class="score" id="placar1">0</span>
    </div>

    <img src="" alt="Sua Logo" class="logo-overlay" id="logoOverlay">

    <div class="team team2">
      <span class="score" id="placar2">0</span>
      <span class="team-name-abbr" id="nomeAbbr2">T2</span>
      <img src="" alt="Escudo Time 2" class="escudo" id="escudo2">
    </div>

    <div class="timer-container">
      <div id="timer">00:00</div>
      <div class="timer-period" id="period">1º T</div>
    </div>

    <div class="cards-container" id="cardsContainer">
        <div class="card-group team1-cards">
            <div class="card-icon yellow"></div>
            <span class="card-count" id="cards1Yellow">0</span>
            <div class="card-icon red"></div>
            <span class="card-count" id="cards1Red">0</span>
        </div>
        <div class="card-group team2-cards">
            <div class="card-icon yellow"></div>
            <span class="card-count" id="cards2Yellow">0</span>
            <div class="card-icon red"></div>
            <span class="card-count" id="cards2Red">0</span>
        </div>
    </div>
  </div>

  <div class="penalties-container" id="penaltiesContainer">
      <div class="penalty-team team1-penalties">
          <span class="penalty-score-label" id="penaltyScore1">Pênaltis T1: 0</span>
          <div class="penalty-marks" id="penaltyMarks1">
              </div>
      </div>
      <div class="penalty-team team2-penalties">
          <span class="penalty-score-label" id="penaltyScore2">Pênaltis T2: 0</span>
          <div class="penalty-marks" id="penaltyMarks2">
              </div>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ** SEU FIREBASE CONFIG ESTÁ AQUI **
    const firebaseConfig = {
      apiKey: "AIzaSyAFp_iujrtqjiTU5yq2yNSBIpwgjQZZyns",
      authDomain: "aquilesplacarpro.firebaseapp.com",
      databaseURL: "https://aquilesplacarpro-default-rtdb.firebaseio.com",
      projectId: "aquilesplacarpro",
      storageBucket: "aquilesplacarpro.firebasestorage.app",
      messagingSenderId: "922321609151",
      appId: "1:922321609151:web:ba51f5b21b322cf0a4c10a"
    };

    // Inicialize o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = app.database();

    // --- MUDANÇA CRÍTICA AQUI: Definição do ID do Jogo (Canal) ---
    const urlParams = new URLSearchParams(window.location.search);
    // 'channel' é o nome do parâmetro na URL (ex: overlay.html?channel=narraju)
    const gameId = urlParams.get('channel') || 'default_channel'; 
    console.log(`Overlay: Ativa para o canal: ${gameId}`);

    // Referência do Firebase para o canal específico
    const gameRef = database.ref('channels').child(gameId); 

    const placar1Element = document.getElementById('placar1');
    const placar2Element = document.getElementById('placar2');
    const nomeAbbr1Element = document.getElementById('nomeAbbr1');
    const nomeAbbr2Element = document.getElementById('nomeAbbr2');
    const escudo1Element = document.getElementById('escudo1');
    const escudo2Element = document.getElementById('escudo2');
    const logoOverlayElement = document.getElementById('logoOverlay');
    const timerElement = document.getElementById('timer');
    const periodElement = document.getElementById('period');
    const overlayContainer = document.getElementById('overlayContainer');
    const cards1YellowElement = document.getElementById('cards1Yellow');
    const cards1RedElement = document.getElementById('cards1Red');
    const cards2YellowElement = document.getElementById('cards2Yellow');
    const cards2RedElement = document.getElementById('cards2Red');
    const penaltiesContainer = document.getElementById('penaltiesContainer');
    const penaltyScore1Element = document.getElementById('penaltyScore1');
    const penaltyScore2Element = document.getElementById('penaltyScore2');
    const penaltyMarks1Element = document.getElementById('penaltyMarks1');
    const penaltyMarks2Element = document.getElementById('penaltyMarks2');

    let currentOverlayState = {
      placar: { '1': 0, '2': 0 },
      cards: { '1': { 'amarelo': 0, 'vermelho': 0 }, '2': { 'amarelo': 0, 'vermelho': 0 } },
      penalties: { '1': [], '2': [] },
      seconds: 0,
      timerRunning: false,
      placarThemeIndex: 0,
      placarOpacity: 90, 
      penaltyModeActive: false,
      activeAnimation: null, 
      currentPeriod: 1,
      nome1: '',
      nome2: '',
      nomeAbbr1: 'T1', 
      nomeAbbr2: 'T2', 
      escudo1: '',
      escudo2: '',
      logoOverlay: '', 
      isVisible: true
    };

    let timerDisplayInterval;

    const placarThemes = [
      { rgb: '34, 34, 34', text: 'white', border: '#555', timerColor: '#0ff' }, 
      { rgb: '0, 123, 255', text: 'white', border: '#0056b3', timerColor: '#fff' },
      { rgb: '40, 167, 69', text: 'white', border: '#218838', timerColor: '#fff' },
      { rgb: '220, 53, 69', text: 'white', border: '#c82333', timerColor: '#fff' },
      { rgb: '255, 193, 7', text: 'black', border: '#e0a800', timerColor: '#333' }
    ];

    const periodNames = {
        0: 'Parado',
        1: '1º T', 
        2: '2º T',
        3: 'Prorrog', 
        4: 'Int', 
        5: 'T. Extra' 
    };

    document.addEventListener('DOMContentLoaded', () => {
      console.log("Overlay: DOMContentLoaded - Configurando listener Firebase.");
      gameRef.on('value', (snapshot) => { 
        if (snapshot.exists()) {
          const data = snapshot.val();
          console.log("Overlay: Dados recebidos do Firebase:", data);
          
          // Preservar o estado local do timer se o Firebase não o enviar explicitamente
          const prevTimerRunning = currentOverlayState.timerRunning;
          const prevSeconds = currentOverlayState.seconds;

          Object.assign(currentOverlayState, { 
            placar: { '1': 0, '2': 0 }, // Garantir que placar, cards, penalties sejam objetos
            cards: { '1': { 'amarelo': 0, 'vermelho': 0 }, '2': { 'amarelo': 0, 'vermelho': 0 } },
            penalties: { '1': [], '2': [] },
            seconds: 0,
            timerRunning: false,
            placarThemeIndex: 0,
            placarOpacity: 90, 
            penaltyModeActive: false,
            activeAnimation: null, 
            currentPeriod: 1,
            nome1: '',
            nome2: '',
            nomeAbbr1: 'T1', 
            nomeAbbr2: 'T2', 
            escudo1: '',
            escudo2: '',
            logoOverlay: '', 
            isVisible: true,
            ...data 
          });

          // Se o timer estava rodando e Firebase diz que deve continuar, reinicia o display
          if (currentOverlayState.timerRunning) {
              if (!timerDisplayInterval) { // Apenas se já não estiver rodando
                  startTimerDisplay();
              }
          } else {
              stopTimerDisplay(); // Garante que pare se o controlador pausou
          }

          updateOverlay();
          applyTheme();
        } else {
          console.log(`Overlay: Nenhum dado no Firebase para o canal '${gameId}'. Exibindo padrões.`);
          // Limpa a overlay se não houver dados no Firebase
          Object.assign(currentOverlayState, {
              placar: { '1': 0, '2': 0 },
              cards: { '1': { 'amarelo': 0, 'vermelho': 0 }, '2': { 'amarelo': 0, 'vermelho': 0 } },
              penalties: { '1': [], '2': [] },
              seconds: 0,
              timerRunning: false,
              placarThemeIndex: 0,
              placarOpacity: 90,
              penaltyModeActive: false,
              activeAnimation: null,
              currentPeriod: 1,
              nome1: '',
              nome2: '',
              nomeAbbr1: 'T1',
              nomeAbbr2: 'T2',
              escudo1: '',
              escudo2: '',
              logoOverlay: '',
              isVisible: true
          });
          updateOverlay();
          applyTheme();
          stopTimerDisplay();
        }
      });
    });

    function formatTime(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimerDisplay() {
        if (timerDisplayInterval) {
            clearInterval(timerDisplayInterval);
        }
        timerDisplayInterval = setInterval(() => {
            timerElement.textContent = formatTime(currentOverlayState.seconds);
        }, 1000);
        console.log("Overlay: Timer display iniciado.");
    }

    function stopTimerDisplay() {
        if (timerDisplayInterval) {
            clearInterval(timerDisplayInterval);
            timerDisplayInterval = null;
            console.log("Overlay: Timer display parado.");
        }
    }

    function updateOverlay() {
      placar1Element.textContent = currentOverlayState.placar['1'];
      placar2Element.textContent = currentOverlayState.placar['2'];
      nomeAbbr1Element.textContent = currentOverlayState.nomeAbbr1 || 'T1'; // Fallback para T1
      nomeAbbr2Element.textContent = currentOverlayState.nomeAbbr2 || 'T2'; // Fallback para T2

      // Assegurar que src seja vazio se não houver imagem para esconder o broken image icon
      escudo1Element.src = currentOverlayState.escudo1 || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; 
      escudo2Element.src = currentOverlayState.escudo2 || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
      logoOverlayElement.src = currentOverlayState.logoOverlay || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';


      timerElement.textContent = formatTime(currentOverlayState.seconds);
      periodElement.textContent = periodNames[currentOverlayState.currentPeriod] || 'N/A';

      cards1YellowElement.textContent = (currentOverlayState.cards['1'] && currentOverlayState.cards['1']['amarelo'] !== undefined) ? currentOverlayState.cards['1']['amarelo'] : 0;
      cards1RedElement.textContent = (currentOverlayState.cards['1'] && currentOverlayState.cards['1']['vermelho'] !== undefined) ? currentOverlayState.cards['1']['vermelho'] : 0;
      cards2YellowElement.textContent = (currentOverlayState.cards['2'] && currentOverlayState.cards['2']['amarelo'] !== undefined) ? currentOverlayState.cards['2']['amarelo'] : 0;
      cards2RedElement.textContent = (currentOverlayState.cards['2'] && currentOverlayState.cards['2']['vermelho'] !== undefined) ? currentOverlayState.cards['2']['vermelho'] : 0;

      // Lógica da animação de gol
      if (currentOverlayState.activeAnimation === 'goalAnimation') {
          overlayContainer.classList.add('goal-animation');
      } else {
          overlayContainer.classList.remove('goal-animation');
      }

      if (currentOverlayState.isVisible) {
          overlayContainer.classList.remove('hidden');
      } else {
          overlayContainer.classList.add('hidden');
      }

      if (currentOverlayState.penaltyModeActive) {
          penaltiesContainer.classList.add('active');
          renderPenalties();
      } else {
          penaltiesContainer.classList.remove('active');
      }
    }

    function applyTheme() {
        const theme = placarThemes[currentOverlayState.placarThemeIndex];
        document.documentElement.style.setProperty('--placar-bg-rgb', theme.rgb);
        document.documentElement.style.setProperty('--placar-text', theme.text);
        document.documentElement.style.setProperty('--placar-border', theme.border);
        document.documentElement.style.setProperty('--placar-timer-color', theme.timerColor);
        document.documentElement.style.setProperty('--placar-opacity', currentOverlayState.placarOpacity / 100);
    }

    function renderPenalties() {
        let converted1 = 0;
        penaltyMarks1Element.innerHTML = '';
        const team1Penalties = currentOverlayState.penalties['1'] || [];
        for (let i = 0; i < 5; i++) { 
            const mark = document.createElement('div');
            mark.classList.add('penalty-mark');
            if (team1Penalties[i]) {
                mark.classList.add(team1Penalties[i]);
                if (team1Penalties[i] === 'green') converted1++;
            }
            penaltyMarks1Element.appendChild(mark);
        }
        penaltyScore1Element.textContent = `Pênaltis T1: ${converted1}`;

        let converted2 = 0;
        penaltyMarks2Element.innerHTML = '';
        const team2Penalties = currentOverlayState.penalties['2'] || [];
        for (let i = 0; i < 5; i++) { 
            const mark = document.createElement('div');
            mark.classList.add('penalty-mark');
            if (team2Penalties[i]) {
                mark.classList.add(team2Penalties[i]);
                if (team2Penalties[i] === 'green') converted2++;
            }
            penaltyMarks2Element.appendChild(mark);
        }
        penaltyScore2Element.textContent = `Pênaltis T2: ${converted2}`;
    }
  </script>
</body>
</html>
